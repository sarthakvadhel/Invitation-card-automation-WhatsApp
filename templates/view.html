{% extends "base.html" %}

{% block title %}View & Send - Invitation Automation{% endblock %}

{% block extra_css %}
<style>
    .table-container {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        background: white;
    }
    
    th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 1em;
    }
    
    td {
        padding: 12px 15px;
        border-bottom: 1px solid #e9ecef;
    }
    
    tr:hover {
        background: #f8f9fa;
    }
    
    .gujarati-text {
        font-size: 1.1em;
        color: #d63384;
        font-weight: 600;
    }
    
    .btn-group {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .btn-whatsapp {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        font-size: 0.9em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        color: white;
    }
    
    .btn-sarthak {
        background: #25D366;
    }
    
    .btn-vanrajbhai {
        background: #128C7E;
    }
    
    .btn-vasudha {
        background: #075E54;
    }
    
    .btn-whatsapp:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .btn-whatsapp:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-delete {
        padding: 8px 15px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-delete:hover {
        background: #c82333;
    }
    
    .remark {
        font-size: 0.9em;
        color: #28a745;
        font-style: italic;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-state h3 {
        margin-bottom: 15px;
        font-size: 1.5em;
    }
    
    .empty-state p {
        margin-bottom: 25px;
    }
    
    .btn-add {
        display: inline-block;
        padding: 12px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-weight: 600;
        transition: transform 0.2s;
    }
    
    .btn-add:hover {
        transform: translateY(-2px);
    }
    
    .stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 30px;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .stat-card {
        flex: 1;
        min-width: 200px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-card h3 {
        font-size: 2.5em;
        margin-bottom: 5px;
    }
    
    .stat-card p {
        font-size: 1em;
        opacity: 0.9;
    }
    
    .loading {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 1000;
    }
    
    .loading.show {
        display: block;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .btn-group {
            flex-direction: column;
        }
        
        table {
            font-size: 0.9em;
        }
        
        th, td {
            padding: 8px;
        }
    }
    
    .btn-contact-small {
        padding: 5px 10px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-contact-small:hover {
        background: #218838;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 20px; color: #333;">üìã Invitation Entries</h2>

{% if entries %}
    <div class="stats">
        <div class="stat-card">
            <h3>{{ entries|length }}</h3>
            <p>Total Entries</p>
        </div>
        <div class="stat-card">
            <h3>{{ entries|selectattr('remark')|list|length }}</h3>
            <p>Sent</p>
        </div>
        <div class="stat-card">
            <h3>{{ entries|rejectattr('remark')|list|length }}</h3>
            <p>Pending</p>
        </div>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name (English)</th>
                    <th>Name (Gujarati)</th>
                    <th>Mobile</th>
                    <th>Send Via WhatsApp</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr id="row-{{ entry.id }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ entry.name_english }}</td>
                    <td class="gujarati-text">{{ entry.name_gujarati }}</td>
                    <td>
                        <div style="display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                            <input 
                                type="tel" 
                                id="mobile-{{ entry.id }}" 
                                value="{{ entry.mobile or '' }}" 
                                placeholder="Add mobile..."
                                pattern="[0-9]{10,15}"
                                style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: 140px; font-size: 0.9em;"
                                onchange="updateMobile({{ entry.id }})"
                                data-has-mobile="{{ 'true' if entry.mobile else 'false' }}"
                            >
                            <button 
                                type="button" 
                                class="btn-contact-small" 
                                onclick="selectContactForEntry({{ entry.id }})" 
                                title="Select from Contacts"
                            >
                                üìû
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button 
                                class="btn-whatsapp btn-sarthak" 
                                onclick="sendInvitation({{ entry.id }}, 'sarthak')"
                                {% if entry.remark or not entry.mobile %}disabled{% endif %}
                                data-entry-id="{{ entry.id }}"
                            >
                                üì± Sarthak
                            </button>
                            <button 
                                class="btn-whatsapp btn-vanrajbhai" 
                                onclick="sendInvitation({{ entry.id }}, 'vanrajbhai')"
                                {% if entry.remark or not entry.mobile %}disabled{% endif %}
                                data-entry-id="{{ entry.id }}"
                            >
                                üì± Vanrajbhai
                            </button>
                            <button 
                                class="btn-whatsapp btn-vasudha" 
                                onclick="sendInvitation({{ entry.id }}, 'vasudha')"
                                {% if entry.remark or not entry.mobile %}disabled{% endif %}
                                data-entry-id="{{ entry.id }}"
                            >
                                üì± Vasudha
                            </button>
                        </div>
                    </td>
                    <td>
                        <span class="remark" id="remark-{{ entry.id }}">
                            {% if entry.remark %}
                                ‚úì {{ entry.remark }}
                            {% else %}
                                Pending
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        <button class="btn-delete" onclick="deleteEntry({{ entry.id }})">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="empty-state">
        <h3>üì≠ No entries yet</h3>
        <p>Add your first guest to start sending invitations!</p>
        <a href="{{ url_for('add_entry') }}" class="btn-add">‚ûï Add First Entry</a>
    </div>
{% endif %}

<div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Generating invitation PDF...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Contact Picker fallback message (shared constant)
    const CONTACT_PICKER_FALLBACK_MESSAGE = 'Contact Picker Feature:\n\n' +
          'Unfortunately, your browser/platform does not support the Contact Picker API.\n\n' +
          'Supported platforms:\n' +
          '‚Ä¢ Android (Chrome, Edge)\n' +
          '‚Ä¢ Some newer desktop browsers\n\n' +
          'Please enter the mobile number manually.\n\n' +
          'Note: iOS Safari and most desktop browsers do not currently support this feature due to privacy restrictions.';
    
    // Mobile number validation constants
    const MIN_MOBILE_LENGTH = 10;
    const MAX_MOBILE_LENGTH = 15;
    
    // Sender names from backend
    const senderNames = {
        {% for key, sender in senders.items() %}
        '{{ key }}': '{{ sender.name }}',
        {% endfor %}
    };
    
    // Track current entry being processed
    let currentEntryId = null;
    let currentSenderKey = null;
    let awaitingReturn = false;
    
    // Detect platform for WhatsApp link
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // Get WhatsApp URL based on platform
    function getWhatsAppUrl(mobile, message) {
        const encodedMessage = encodeURIComponent(message);
        
        if (isMobileDevice()) {
            // Mobile: Opens WhatsApp app directly
            return `whatsapp://send?phone=${mobile}&text=${encodedMessage}`;
        } else {
            // Desktop: Opens WhatsApp Web
            return `https://web.whatsapp.com/send?phone=${mobile}&text=${encodedMessage}`;
        }
    }
    
    // Listen for page visibility changes (when user returns)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && awaitingReturn && currentEntryId) {
            // User returned to the page
            awaitingReturn = false;
            
            // Add 3-second delay before showing confirmation dialog
            // This allows the WhatsApp popup to close/settle first
            setTimeout(() => {
                showConfirmationDialog(currentEntryId, currentSenderKey);
            }, 3000);
        }
    });
    
    async function sendInvitation(entryId, senderKey) {
        // Get entry data
        const row = document.getElementById(`row-${entryId}`);
        const mobileInput = document.getElementById(`mobile-${entryId}`);
        const mobile = mobileInput.value.trim();
        const nameGujarati = row.cells[2].textContent.trim();
        
        // Validate mobile number (extra safety check)
        if (!mobile || mobile.length < MIN_MOBILE_LENGTH) {
            alert('Please add a valid mobile number first before sending the invitation.\n\nMobile number must be at least ' + MIN_MOBILE_LENGTH + ' digits.');
            mobileInput.focus();
            return;
        }
        
        // Get sender name from global senderNames object
        const senderName = senderNames[senderKey] || 'Unknown';
        
        // Create WhatsApp message
        const message = `‡™®‡™Æ‡™∏‡´ç‡™§‡´á ${nameGujarati},
‡™Ü‡™™‡™®‡´á ‡™Ö‡™®‡´á ‡™Ü‡™™‡™®‡™æ ‡™™‡™∞‡™ø‡™µ‡™æ‡™∞‡™®‡´á ‡™Ö‡™Æ‡™æ‡™∞‡™æ ‡™≤‡™ó‡´ç‡™® ‡™∏‡™Æ‡™æ‡™∞‡´ã‡™π‡™Æ‡™æ‡™Ç ‡™Ü‡™Æ‡™Ç‡™§‡´ç‡™∞‡™ø‡™§ ‡™ï‡™∞‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™Ü‡™®‡™Ç‡™¶ ‡™•‡™æ‡™Ø ‡™õ‡´á.
‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™Ü‡™Æ‡™Ç‡™§‡´ç‡™∞‡™£ ‡™ï‡™æ‡™∞‡´ç‡™° ‡™®‡´á ‡™∞‡´Ç‡™¨‡™∞‡´Ç ‡™Æ‡™≥‡´ç‡™Ø‡™æ ‡™§‡´Å‡™≤‡´ç‡™Ø ‡™∏‡™Æ‡™ú‡´Ä ‡™Ü ‡™µ‡™¢‡´á‡™≥ ‡™™‡™∞‡™ø‡™µ‡™æ‡™∞‡™®‡™æ ‡™§‡´á‡™°‡™æ‡™®‡´á ‡™∏‡´ç‡™µ‡´Ä‡™ï‡™æ‡™∞‡´Ä‡™®‡´á 
‡™Ö‡™Æ‡™æ‡™∞‡™æ ‡™™‡´ç‡™∞‡™∏‡™Ç‡™ó‡™Æ‡™æ‡™Ç ‡™Ö‡™≠‡™ø‡™µ‡´É‡™ß‡´ç‡™ß‡™ø ‡™ï‡™∞‡™∂‡´ã‡™ú‡´Ä.

‡™∏‡™æ‡™¶‡™∞,
${senderName}`;
        
        // Store current entry for confirmation later
        currentEntryId = entryId;
        currentSenderKey = senderKey;
        
        // Check if Web Share API is available with file support
        if (navigator.share && navigator.canShare) {
            try {
                // Show loading indicator
                document.getElementById('loading').classList.add('show');
                
                // Fetch the PDF blob
                console.log('Fetching PDF for entry:', entryId);
                const response = await fetch(`/generate-pdf-blob/${entryId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to generate PDF');
                }
                
                const pdfBlob = await response.blob();
                const pdfFile = new File([pdfBlob], "Vadhel Sarthak's Wedding Invitation.pdf", { type: 'application/pdf' });
                
                // Check if we can share files
                const shareData = {
                    title: 'Wedding Invitation',
                    text: message,
                    files: [pdfFile]
                };
                
                if (navigator.canShare(shareData)) {
                    // Hide loading indicator
                    document.getElementById('loading').classList.remove('show');
                    
                    // Share using Web Share API
                    await navigator.share(shareData);
                    
                    // Show confirmation dialog after sharing
                    setTimeout(() => {
                        showConfirmationDialog(entryId, senderKey);
                    }, 1000);
                } else {
                    // Fall back to old method if file sharing is not supported
                    console.log('File sharing not supported, using fallback method');
                    document.getElementById('loading').classList.remove('show');
                    useFallbackMethod(entryId, mobile, message, senderName);
                }
            } catch (error) {
                console.error('Error sharing via Web Share API:', error);
                document.getElementById('loading').classList.remove('show');
                
                // If user cancelled or error occurred, use fallback
                if (error.name === 'AbortError') {
                    // User cancelled the share
                    currentEntryId = null;
                    currentSenderKey = null;
                    return;
                }
                
                // Use fallback method for other errors
                useFallbackMethod(entryId, mobile, message, senderName);
            }
        } else {
            // Web Share API not available, use fallback
            console.log('Web Share API not available, using fallback method');
            useFallbackMethod(entryId, mobile, message, senderName);
        }
    }
    
    function useFallbackMethod(entryId, mobile, message, senderName) {
        // This is the old method: download PDF and open WhatsApp separately
        awaitingReturn = true;
        
        console.log('Using fallback method: download PDF + open WhatsApp');
        
        // Open PDF generation in new tab (will trigger download)
        const pdfWindow = window.open(`/generate-pdf/${entryId}`, '_blank');
        
        // Wait a bit for PDF download to start, then open WhatsApp
        setTimeout(() => {
            // Get WhatsApp URL
            const whatsappUrl = getWhatsAppUrl(mobile, message);
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // Show instruction to user
            setTimeout(() => {
                if (awaitingReturn) {
                    alert('Instructions:\n\n1. The invitation PDF has been downloaded: "Vadhel Sarthak\'s Wedding Invitation.pdf"\n2. WhatsApp is now open with the message\n3. Please attach the downloaded PDF file to WhatsApp\n4. Send the message\n5. Return to this page to confirm');
                }
            }, 1500);
        }, 1000);
    }
    
    function showConfirmationDialog(entryId, senderKey) {
        const confirmed = confirm('Did you successfully send the invitation on WhatsApp?');
        
        if (confirmed) {
            // Get proper sender name from global senderNames object
            const senderName = senderNames[senderKey] || 'Unknown';
            
            // Print/display sender name as required
            console.log(`‚úì Successfully sent by: ${senderName}`);
            
            // Ask for remark with sender name as default
            const remark = prompt('Please enter a remark (optional):', `Sent by ${senderName} on ${new Date().toLocaleString()}`);
            
            if (remark !== null) {
                // Ensure sender name is always included in the remark
                let finalRemark = remark.trim();
                
                if (finalRemark === '') {
                    // If user cleared the remark, use default with sender name
                    finalRemark = `Sent by ${senderName}`;
                } else {
                    // Escape special regex characters in sender name
                    const escapedSender = senderName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    // Check if sender name is already in the remark (with word boundaries)
                    const senderPattern = new RegExp(`\\b${escapedSender}\\b`, 'i');
                    if (!senderPattern.test(finalRemark)) {
                        // If custom remark doesn't include sender name, append it
                        finalRemark = `${finalRemark} (by ${senderName})`;
                    }
                }
                
                // Update the database with the remark
                updateRemark(entryId, finalRemark, senderName);
            }
        } else {
            // Reset tracking
            currentEntryId = null;
            currentSenderKey = null;
        }
    }
    
    function updateRemark(entryId, remark, senderName) {
        fetch(`/update-remark/${entryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ remark: remark })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update remark in UI - always display the remark which now includes sender name
                document.getElementById(`remark-${entryId}`).textContent = '‚úì ' + remark;
                document.getElementById(`remark-${entryId}`).style.color = '#28a745';
                
                // Disable all WhatsApp buttons for this row
                const row = document.getElementById(`row-${entryId}`);
                const buttons = row.querySelectorAll('.btn-whatsapp');
                buttons.forEach(btn => btn.disabled = true);
                
                // Show sender name in success message as required
                alert(`‚úì Status updated successfully!\n\nSent by: ${senderName}`);
            } else {
                alert('‚úó Failed to update status: ' + (data.error || 'Unknown error'));
            }
            
            // Reset tracking
            currentEntryId = null;
            currentSenderKey = null;
        })
        .catch(error => {
            alert('‚úó Error: ' + error.message);
            currentEntryId = null;
            currentSenderKey = null;
        });
    }
    
    function deleteEntry(entryId) {
        if (!confirm('Are you sure you want to delete this entry?')) {
            return;
        }
        
        fetch(`/delete/${entryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove row from table
                document.getElementById(`row-${entryId}`).remove();
                
                // Check if table is empty
                const tbody = document.querySelector('tbody');
                if (tbody.children.length === 0) {
                    location.reload();
                }
            } else {
                alert('Failed to delete entry');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
    
    function updateMobile(entryId) {
        const mobileInput = document.getElementById(`mobile-${entryId}`);
        const mobile = mobileInput.value.trim();
        
        // Update mobile number in database
        fetch(`/update-mobile/${entryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ mobile: mobile })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update WhatsApp button states
                const row = document.getElementById(`row-${entryId}`);
                const buttons = row.querySelectorAll('.btn-whatsapp');
                const hasMobile = mobile && mobile.length >= MIN_MOBILE_LENGTH && mobile.length <= MAX_MOBILE_LENGTH;
                
                buttons.forEach(btn => {
                    // Only enable if has mobile and not already sent (no remark)
                    const remarkSpan = document.getElementById(`remark-${entryId}`);
                    const hasSent = remarkSpan.textContent.includes('‚úì');
                    btn.disabled = !hasMobile || hasSent;
                });
                
                // Update data attribute
                mobileInput.dataset.hasMobile = hasMobile ? 'true' : 'false';
            } else {
                alert('Failed to update mobile number: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error updating mobile: ' + error.message);
        });
    }
    
    function selectContactForEntry(entryId) {
        // Check if Contact Picker API is available
        if ('contacts' in navigator && 'ContactsManager' in window) {
            const props = ['tel'];
            const opts = {multiple: false};
            
            navigator.contacts.select(props, opts).then(contacts => {
                if (contacts.length > 0 && contacts[0].tel && contacts[0].tel.length > 0) {
                    // Get the phone number and clean it
                    let phoneNumber = contacts[0].tel[0];
                    // Remove spaces, dashes, parentheses, and plus signs
                    phoneNumber = phoneNumber.replace(/[\s\-\(\)\+]/g, '');
                    
                    // Set the value and trigger update
                    const mobileInput = document.getElementById(`mobile-${entryId}`);
                    mobileInput.value = phoneNumber;
                    updateMobile(entryId);
                }
            }).catch(err => {
                console.error('Contact selection error:', err);
                showContactPickerFallback();
            });
        } else {
            // Fallback for browsers that don't support Contact Picker API
            showContactPickerFallback();
        }
    }
    
    function showContactPickerFallback() {
        alert(CONTACT_PICKER_FALLBACK_MESSAGE);
    }
</script>
{% endblock %}
